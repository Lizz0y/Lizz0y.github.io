<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="永远好奇，永远敬畏">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>MultiDex & Instant Run - Lizz0y's Notes</title>

    <link rel="canonical" href="http://localhost:5001/2017/05/02/multiDex&InstantRun/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="http://cdn.staticfile.org/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Liz Notes</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
                    
                    <li>
                        <a href="/tags/">Tags</a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/img/2017-02-01-binder/pic.jpeg" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        background-image: url('/img/2017-02-01-binder/pic.jpeg')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/#插件化" title="插件化">插件化</a>
                        
                        <a class="tag" href="/tags/#热补丁" title="热补丁">热补丁</a>
                        
                    </div>
                    <h1>MultiDex & Instant Run</h1>
                    
                    
                    <h2 class="subheading"></h2>
                    
                    <span class="meta">Posted by Liz on May 2, 2017</span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

				<h3 id="classloader">ClassLoader</h3>

<p><img src="/img/2017-05-02-multidex/14932770207728.png" alt="" /></p>

<ul>
  <li>
    <p><code class="highlighter-rouge">PathClassLoader</code>是Android应用中的默认加载器，<code class="highlighter-rouge">PathClassLoader</code>只能加载<code class="highlighter-rouge">/data/app</code>中的apk，也就是已经安装到手机中的apk。这个也是<code class="highlighter-rouge">PathClassLoader</code>作为默认的类加载器的原因，因为一般程序都是安装了，在打开，这时候<code class="highlighter-rouge">PathClassLoader</code>就去加载指定的apk(解压成dex，然后在优化成odex)就可以了。</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">DexClassLoader</code>可以加载任何路径的<code class="highlighter-rouge">apk/dex/jar</code>，<code class="highlighter-rouge">PathClassLoader</code>只能加载已安装到系统中（即/data/app目录下）的apk文件。</p>
  </li>
</ul>

<h4 id="dexpathlist">DexPathList</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="c1">// definingContext对应的就是当前classLoader</span>
<span class="c1">// dexPath对应的就是上面传进来的apk/dex/jar的路径</span>
<span class="c1">// libraryPath就是上面传进来的加载的时候需要用到的lib库的目录，这个一般不用</span>
<span class="c1">// optimizedDirectory就是上面传进来的dex的输出路径</span>
<span class="kd">public</span> <span class="nf">DexPathList</span><span class="o">(</span><span class="n">ClassLoader</span> <span class="n">definingContext</span><span class="o">,</span> <span class="n">String</span> <span class="n">dexPath</span><span class="o">,</span>
        <span class="n">String</span> <span class="n">libraryPath</span><span class="o">,</span> <span class="n">File</span> <span class="n">optimizedDirectory</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">IOException</span><span class="o">&gt;</span> <span class="n">suppressedExceptions</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">IOException</span><span class="o">&gt;();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">dexElements</span> <span class="o">=</span> <span class="n">makeDexElements</span><span class="o">(</span><span class="n">splitDexPath</span><span class="o">(</span><span class="n">dexPath</span><span class="o">),</span> <span class="n">optimizedDirectory</span><span class="o">,</span>
                                       <span class="n">suppressedExceptions</span><span class="o">);</span>
<span class="o">}</span>
<span class="c1">// files是一个ArrayList&lt;File&gt;列表，它对应的就是apk/dex/jar文件，因为我们可以指定多个文件。</span>
<span class="c1">// optimizedDirectory是前面传入dex的输出路径</span>
<span class="c1">// suppressedExceptions为一个异常列表</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="n">Element</span><span class="o">[]</span> <span class="nf">makeDexElements</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="n">files</span><span class="o">,</span> <span class="n">File</span> <span class="n">optimizedDirectory</span><span class="o">,</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">IOException</span><span class="o">&gt;</span> <span class="n">suppressedExceptions</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Element</span><span class="o">&gt;</span> <span class="n">elements</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Element</span><span class="o">&gt;();</span>
    <span class="cm">/*
     * Open all files and load the (direct or contained) dex files
     * up front.
     */</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">File</span> <span class="n">file</span> <span class="o">:</span> <span class="n">files</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">File</span> <span class="n">zip</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">DexFile</span> <span class="n">dex</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>

        <span class="c1">// 如果是一个dex文件</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">name</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="n">DEX_SUFFIX</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">// Raw dex file (not inside a zip/jar).</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">dex</span> <span class="o">=</span> <span class="n">loadDexFile</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="n">optimizedDirectory</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">logE</span><span class="o">(</span><span class="s">"Unable to load dex file: "</span> <span class="o">+</span> <span class="n">file</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="c1">// 如果是一个apk或者jar或者zip文件</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">name</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="n">APK_SUFFIX</span><span class="o">)</span> <span class="o">||</span> <span class="n">name</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="n">JAR_SUFFIX</span><span class="o">)</span>
                <span class="o">||</span> <span class="n">name</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="n">ZIP_SUFFIX</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">zip</span> <span class="o">=</span> <span class="n">file</span><span class="o">;</span>

            <span class="k">try</span> <span class="o">{</span>
                <span class="n">dex</span> <span class="o">=</span> <span class="n">loadDexFile</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="n">optimizedDirectory</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">suppressed</span><span class="o">)</span> <span class="o">{</span>
                <span class="cm">/*
                 * IOException might get thrown "legitimately" by the DexFile constructor if the
                 * zip file turns out to be resource-only (that is, no classes.dex file in it).
                 * Let dex == null and hang on to the exception to add to the tea-leaves for
                 * when findClass returns null.
                 */</span>
                <span class="n">suppressedExceptions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">suppressed</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">isDirectory</span><span class="o">())</span> <span class="o">{</span>
            <span class="c1">// We support directories for looking up resources.</span>
            <span class="c1">// This is only useful for running libcore tests.</span>
            <span class="n">elements</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Element</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">logW</span><span class="o">(</span><span class="s">"Unknown file type for: "</span> <span class="o">+</span> <span class="n">file</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">((</span><span class="n">zip</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="n">dex</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">elements</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Element</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">zip</span><span class="o">,</span> <span class="n">dex</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">return</span> <span class="n">elements</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="n">Element</span><span class="o">[</span><span class="n">elements</span><span class="o">.</span><span class="na">size</span><span class="o">()]);</span>
<span class="o">}</span>
</code></pre>
</div>

<ul>
  <li>在<code class="highlighter-rouge">DexClassLoader</code>我们指定了加载的<code class="highlighter-rouge">apk/dex/jar</code>文件和<code class="highlighter-rouge">dex</code>输出路径<code class="highlighter-rouge">optimizedDirectory</code>，它最终会被解析得到<code class="highlighter-rouge">DexFile</code>文件。</li>
  <li>将<code class="highlighter-rouge">DexFile</code>文件对象放在<code class="highlighter-rouge">Element</code>对象里面，它对应的就是<code class="highlighter-rouge">Element</code>对象的<code class="highlighter-rouge">dexFile</code>成员变量。</li>
  <li>将这个<code class="highlighter-rouge">Element</code>对象放在一个<code class="highlighter-rouge">Element[]</code>数组中，然后将这个数组返回给<code class="highlighter-rouge">DexPathList</code>的<code class="highlighter-rouge">dexElements</code>成员变量。</li>
  <li><code class="highlighter-rouge">DexPathList</code>是<code class="highlighter-rouge">BaseDexClassLoader</code>的一个成员变量。</li>
</ul>

<p><img src="/img/2017-05-02-multidex/14932823251895.jpg" alt="" /></p>

<h3 id="multidex">MultiDex</h3>

<p>主要只有两个文件:<code class="highlighter-rouge">MultiDex</code>和<code class="highlighter-rouge">MultiDexExtractor</code></p>

<ul>
  <li><code class="highlighter-rouge">Context.getFilesDir()</code>：返回<code class="highlighter-rouge">/data/data/&lt;packagename&gt;/files</code>目录，一般通过<code class="highlighter-rouge">openFileOutput</code>方法输出文件到该目录</li>
  <li><code class="highlighter-rouge">ApplicationInfo.dataDir</code>: 返回<code class="highlighter-rouge">/data/data/&lt;packagename&gt;</code>目录</li>
</ul>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">install</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">"MultiDex"</span><span class="o">,</span> <span class="s">"install"</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">IS_VM_MULTIDEX_CAPABLE</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//虚拟机自身支持,就不用我们瞎BB了</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">"MultiDex"</span><span class="o">,</span> <span class="s">"VM has multidex support, MultiDex support library is disabled."</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">VERSION</span><span class="o">.</span><span class="na">SDK_INT</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//小于4不能用</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"Multi dex installation failed. SDK "</span> <span class="o">+</span> <span class="n">VERSION</span><span class="o">.</span><span class="na">SDK_INT</span> <span class="o">+</span> <span class="s">" is unsupported. Min SDK version is "</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="s">"."</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">ApplicationInfo</span> <span class="n">e</span> <span class="o">=</span> <span class="n">getApplicationInfo</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
                <span class="k">if</span><span class="o">(</span><span class="n">e</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="n">Set</span> <span class="n">var2</span> <span class="o">=</span> <span class="n">installedApk</span><span class="o">;</span>
                <span class="kd">synchronized</span><span class="o">(</span><span class="n">installedApk</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">String</span> <span class="n">apkPath</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">sourceDir</span><span class="o">;</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">installedApk</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">apkPath</span><span class="o">))</span> <span class="o">{</span>
                        <span class="k">return</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="n">installedApk</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">apkPath</span><span class="o">);</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">VERSION</span><span class="o">.</span><span class="na">SDK_INT</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">"MultiDex"</span><span class="o">,</span> <span class="s">"MultiDex is not guaranteed to work in SDK version "</span> <span class="o">+</span> <span class="n">VERSION</span><span class="o">.</span><span class="na">SDK_INT</span> <span class="o">+</span> <span class="s">": SDK version higher than "</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="s">" should be backed by "</span> <span class="o">+</span> <span class="s">"runtime with built-in multidex capabilty but it\'s not the "</span> <span class="o">+</span> <span class="s">"case here: java.vm.version=\""</span> <span class="o">+</span> <span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"java.vm.version"</span><span class="o">)</span> <span class="o">+</span> <span class="s">"\""</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="n">ClassLoader</span> <span class="n">loader</span><span class="o">;</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="n">loader</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">();</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="n">var9</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">"MultiDex"</span><span class="o">,</span> <span class="s">"Failure while trying to obtain Context class loader. Must be running in test mode. Skip patching."</span><span class="o">,</span> <span class="n">var9</span><span class="o">);</span>
                        <span class="k">return</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">loader</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">"MultiDex"</span><span class="o">,</span> <span class="s">"Context class loader is null. Must be running in test mode. Skip patching."</span><span class="o">);</span>
                        <span class="k">return</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="n">clearOldDexDir</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">var8</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">"MultiDex"</span><span class="o">,</span> <span class="s">"Something went wrong when trying to clear old MultiDex extraction, continuing without cleaning."</span><span class="o">,</span> <span class="n">var8</span><span class="o">);</span>
                    <span class="o">}</span>

                    <span class="n">File</span> <span class="n">dexDir</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">dataDir</span><span class="o">,</span> <span class="n">SECONDARY_FOLDER_NAME</span><span class="o">);</span>
                    <span class="c1">////把dex文件缓存到/data/data/&lt;packagename&gt;/code_cache/secondary-dexes/目录</span>
                    <span class="n">List</span> <span class="n">files</span> <span class="o">=</span> <span class="n">MultiDexExtractor</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">e</span><span class="o">,</span> <span class="n">dexDir</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>             
                    <span class="c1">//检查是否为zip文件</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">checkValidZipFiles</span><span class="o">(</span><span class="n">files</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">installSecondaryDexes</span><span class="o">(</span><span class="n">loader</span><span class="o">,</span> <span class="n">dexDir</span><span class="o">,</span> <span class="n">files</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">"MultiDex"</span><span class="o">,</span> <span class="s">"Files were not valid zip files.  Forcing a reload."</span><span class="o">);</span>
                        <span class="n">files</span> <span class="o">=</span> <span class="n">MultiDexExtractor</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">e</span><span class="o">,</span> <span class="n">dexDir</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
                        <span class="k">if</span><span class="o">(!</span><span class="n">checkValidZipFiles</span><span class="o">(</span><span class="n">files</span><span class="o">))</span> <span class="o">{</span>
                            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"Zip files were not valid."</span><span class="o">);</span>
                        <span class="o">}</span>
                        <span class="n">installSecondaryDexes</span><span class="o">(</span><span class="n">loader</span><span class="o">,</span> <span class="n">dexDir</span><span class="o">,</span> <span class="n">files</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">var11</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">"MultiDex"</span><span class="o">,</span> <span class="s">"Multidex installation failure"</span><span class="o">,</span> <span class="n">var11</span><span class="o">);</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"Multi dex installation failed ("</span> <span class="o">+</span> <span class="n">var11</span><span class="o">.</span><span class="na">getMessage</span><span class="o">()</span> <span class="o">+</span> <span class="s">")."</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">"MultiDex"</span><span class="o">,</span> <span class="s">"install done"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="load">load</h4>

<p>解压apk文件中的classes2.dex、classes3.dex等文件解压到dexDir目录中,当然如果已经有了直接加载好啦</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="nf">load</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">ApplicationInfo</span> <span class="n">applicationInfo</span><span class="o">,</span> <span class="n">File</span> <span class="n">dexDir</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">forceReload</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
<span class="c1">///data/app/com.sina.weibo.sdk.demo-1.apk</span>
    <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">"MultiDex"</span><span class="o">,</span> <span class="s">"MultiDexExtractor.load("</span> <span class="o">+</span> <span class="n">applicationInfo</span><span class="o">.</span><span class="na">sourceDir</span> <span class="o">+</span> <span class="s">", "</span> <span class="o">+</span> <span class="n">forceReload</span> <span class="o">+</span> <span class="s">")"</span><span class="o">);</span>
    <span class="n">File</span> <span class="n">sourceApk</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">applicationInfo</span><span class="o">.</span><span class="na">sourceDir</span><span class="o">);</span>
    <span class="kt">long</span> <span class="n">currentCrc</span> <span class="o">=</span> <span class="n">getZipCrc</span><span class="o">(</span><span class="n">sourceApk</span><span class="o">);</span>
    <span class="n">List</span> <span class="n">files</span><span class="o">;</span>
        <span class="c1">//使用SharedPreferences存时间戳和crc来决定是否更新，其实就是用一个生命周期与dex文件相同的位置去存储数据就好</span>
    <span class="k">if</span><span class="o">(!</span><span class="n">forceReload</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isModified</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">sourceApk</span><span class="o">,</span> <span class="n">currentCrc</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">loadExistingExtractions</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">sourceApk</span><span class="o">,</span> <span class="n">dexDir</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">var9</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">"MultiDex"</span><span class="o">,</span> <span class="s">"Failed to reload existing extracted secondary dex files, falling back to fresh extraction"</span><span class="o">,</span> <span class="n">var9</span><span class="o">);</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">performExtractions</span><span class="o">(</span><span class="n">sourceApk</span><span class="o">,</span> <span class="n">dexDir</span><span class="o">);</span>
            <span class="n">putStoredApkInfo</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">getTimeStamp</span><span class="o">(</span><span class="n">sourceApk</span><span class="o">),</span> <span class="n">currentCrc</span><span class="o">,</span> <span class="n">files</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">"MultiDex"</span><span class="o">,</span> <span class="s">"Detected that extraction must be performed."</span><span class="o">);</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">performExtractions</span><span class="o">(</span><span class="n">sourceApk</span><span class="o">,</span> <span class="n">dexDir</span><span class="o">);</span>
        <span class="n">putStoredApkInfo</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">getTimeStamp</span><span class="o">(</span><span class="n">sourceApk</span><span class="o">),</span> <span class="n">currentCrc</span><span class="o">,</span> <span class="n">files</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">"MultiDex"</span><span class="o">,</span> <span class="s">"load found "</span> <span class="o">+</span> <span class="n">files</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">+</span> <span class="s">" secondary dex files"</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">files</span><span class="o">;</span>
<span class="o">}</span>
</code></pre>
</div>

<p>可以看到,如果没有更改,直接loadExisting:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="nf">loadExistingExtractions</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">File</span> <span class="n">sourceApk</span><span class="o">,</span> <span class="n">File</span> <span class="n">dexDir</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">"MultiDex"</span><span class="o">,</span> <span class="s">"loading existing secondary dex files"</span><span class="o">);</span>
    <span class="n">String</span> <span class="n">extractedFilePrefix</span> <span class="o">=</span> <span class="n">sourceApk</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">".classes"</span><span class="o">;</span>
    <span class="c1">//有多少个dex</span>
    <span class="kt">int</span> <span class="n">totalDexNumber</span> <span class="o">=</span> <span class="n">getMultiDexPreferences</span><span class="o">(</span><span class="n">context</span><span class="o">).</span><span class="na">getInt</span><span class="o">(</span><span class="s">"dex.number"</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
    <span class="n">ArrayList</span> <span class="n">files</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">(</span><span class="n">totalDexNumber</span><span class="o">);</span>
    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">secondaryNumber</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span> <span class="n">secondaryNumber</span> <span class="o">&lt;=</span> <span class="n">totalDexNumber</span><span class="o">;</span> <span class="o">++</span><span class="n">secondaryNumber</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">extractedFilePrefix</span> <span class="o">+</span> <span class="n">secondaryNumber</span> <span class="o">+</span> <span class="s">".zip"</span><span class="o">;</span>
        <span class="n">File</span> <span class="n">extractedFile</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">dexDir</span><span class="o">,</span> <span class="n">fileName</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(!</span><span class="n">extractedFile</span><span class="o">.</span><span class="na">isFile</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"Missing extracted secondary dex file \'"</span> <span class="o">+</span> <span class="n">extractedFile</span><span class="o">.</span><span class="na">getPath</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\'"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">files</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">extractedFile</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(!</span><span class="n">verifyZipFile</span><span class="o">(</span><span class="n">extractedFile</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">"MultiDex"</span><span class="o">,</span> <span class="s">"Invalid zip file: "</span> <span class="o">+</span> <span class="n">extractedFile</span><span class="o">);</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"Invalid ZIP file."</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">files</span><span class="o">;</span>
<span class="o">}</span>

</code></pre>
</div>

<p>所有<code class="highlighter-rouge">secondary dex</code>输出为<code class="highlighter-rouge">zip</code>文件，这样是为了保持和<code class="highlighter-rouge">DexClassLoader</code>和<code class="highlighter-rouge">DexPathList</code>的兼容</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="nf">performExtractions</span><span class="o">(</span><span class="n">File</span> <span class="n">sourceApk</span><span class="o">,</span> <span class="n">File</span> <span class="n">dexDir</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">extractedFilePrefix</span> <span class="o">=</span> <span class="n">sourceApk</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">".classes"</span><span class="o">;</span>
    <span class="n">prepareDexDir</span><span class="o">(</span><span class="n">dexDir</span><span class="o">,</span> <span class="n">extractedFilePrefix</span><span class="o">);</span>
    <span class="n">ArrayList</span> <span class="n">files</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">();</span>
    <span class="n">ZipFile</span> <span class="n">apk</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ZipFile</span><span class="o">(</span><span class="n">sourceApk</span><span class="o">);</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">e</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
        <span class="k">for</span><span class="o">(</span><span class="n">ZipEntry</span> <span class="n">dexFile</span> <span class="o">=</span> <span class="n">apk</span><span class="o">.</span><span class="na">getEntry</span><span class="o">(</span><span class="s">"classes"</span> <span class="o">+</span> <span class="n">e</span> <span class="o">+</span> <span class="s">".dex"</span><span class="o">);</span> <span class="n">dexFile</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span> <span class="n">dexFile</span> <span class="o">=</span> <span class="n">apk</span><span class="o">.</span><span class="na">getEntry</span><span class="o">(</span><span class="s">"classes"</span> <span class="o">+</span> <span class="n">e</span> <span class="o">+</span> <span class="s">".dex"</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">extractedFilePrefix</span> <span class="o">+</span> <span class="n">e</span> <span class="o">+</span> <span class="s">".zip"</span><span class="o">;</span>
            <span class="n">File</span> <span class="n">extractedFile</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">dexDir</span><span class="o">,</span> <span class="n">fileName</span><span class="o">);</span>
            <span class="n">files</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">extractedFile</span><span class="o">);</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">"MultiDex"</span><span class="o">,</span> <span class="s">"Extraction is needed for file "</span> <span class="o">+</span> <span class="n">extractedFile</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">numAttempts</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="kt">boolean</span> <span class="n">isExtractionSuccessful</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="k">while</span><span class="o">(</span><span class="n">numAttempts</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isExtractionSuccessful</span><span class="o">)</span> <span class="o">{</span>
                <span class="o">++</span><span class="n">numAttempts</span><span class="o">;</span>
                    <span class="c1">//extract得到的是zip文件,简言之，这个方法做的事情就是，将Apk文件解压后得到的classes2.dex, …, classesN.dex文件的内容依次写入到/data/data/pkgName/code_cache/secondary-dexes/apkName.apk.classes2.zip, …, /data/data/pkgName/code_cache/secondary-dexes/apkName.apk.classesN.zip压缩文件的classes.dex文件中。</span>
                <span class="n">extract</span><span class="o">(</span><span class="n">apk</span><span class="o">,</span> <span class="n">dexFile</span><span class="o">,</span> <span class="n">extractedFile</span><span class="o">,</span> <span class="n">extractedFilePrefix</span><span class="o">);</span>
                <span class="n">isExtractionSuccessful</span> <span class="o">=</span> <span class="n">verifyZipFile</span><span class="o">(</span><span class="n">extractedFile</span><span class="o">);</span>
                <span class="n">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="s">"MultiDex"</span><span class="o">,</span> <span class="s">"Extraction "</span> <span class="o">+</span> <span class="o">(</span><span class="n">isExtractionSuccessful</span><span class="o">?</span><span class="s">"success"</span><span class="o">:</span><span class="s">"failed"</span><span class="o">)</span> <span class="o">+</span> <span class="s">" - length "</span> <span class="o">+</span> <span class="n">extractedFile</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">()</span> <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">extractedFile</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
                <span class="k">if</span><span class="o">(!</span><span class="n">isExtractionSuccessful</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">extractedFile</span><span class="o">.</span><span class="na">delete</span><span class="o">();</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">extractedFile</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
                        <span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">"MultiDex"</span><span class="o">,</span> <span class="s">"Failed to delete corrupted secondary dex \'"</span> <span class="o">+</span> <span class="n">extractedFile</span><span class="o">.</span><span class="na">getPath</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\'"</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">if</span><span class="o">(!</span><span class="n">isExtractionSuccessful</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"Could not create zip file "</span> <span class="o">+</span> <span class="n">extractedFile</span><span class="o">.</span><span class="na">getAbsolutePath</span><span class="o">()</span> <span class="o">+</span> <span class="s">" for secondary dex ("</span> <span class="o">+</span> <span class="n">e</span> <span class="o">+</span> <span class="s">")"</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="o">++</span><span class="n">e</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">apk</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">var16</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">"MultiDex"</span><span class="o">,</span> <span class="s">"Failed to close resource"</span><span class="o">,</span> <span class="n">var16</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">files</span><span class="o">;</span>
<span class="o">}</span>
</code></pre>
</div>

<h4 id="install">install</h4>

<p>install的输入是zip,并根据api分V4/V14/V19三种进行注册。</p>

<p>注册过程就是classLoader的dexPath过程。</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">install</span><span class="o">(</span><span class="n">ClassLoader</span> <span class="n">loader</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="n">additionalClassPathEntries</span><span class="o">,</span> <span class="n">File</span> <span class="n">optimizedDirectory</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IllegalArgumentException</span><span class="o">,</span> <span class="n">IllegalAccessException</span><span class="o">,</span> <span class="n">NoSuchFieldException</span><span class="o">,</span> <span class="n">InvocationTargetException</span><span class="o">,</span> <span class="n">NoSuchMethodException</span> <span class="o">{</span>
    <span class="n">Field</span> <span class="n">pathListField</span> <span class="o">=</span> <span class="n">MultiDex</span><span class="o">.</span><span class="na">findField</span><span class="o">(</span><span class="n">loader</span><span class="o">,</span> <span class="s">"pathList"</span><span class="o">);</span>
    <span class="n">Object</span> <span class="n">dexPathList</span> <span class="o">=</span> <span class="n">pathListField</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">loader</span><span class="o">);</span>
    <span class="n">MultiDex</span><span class="o">.</span><span class="na">expandFieldArray</span><span class="o">(</span><span class="n">dexPathList</span><span class="o">,</span> <span class="s">"dexElements"</span><span class="o">,</span><span class="n">makeDexElements</span><span class="o">(</span><span class="n">dexPathList</span><span class="o">,</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">(</span><span class="n">additionalClassPathEntries</span><span class="o">),</span> <span class="n">optimizedDirectory</span><span class="o">));</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="n">Object</span><span class="o">[]</span> <span class="nf">makeDexElements</span><span class="o">(</span><span class="n">Object</span> <span class="n">dexPathList</span><span class="o">,</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span> <span class="n">files</span><span class="o">,</span> <span class="n">File</span> <span class="n">optimizedDirectory</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IllegalAccessException</span><span class="o">,</span> <span class="n">InvocationTargetException</span><span class="o">,</span> <span class="n">NoSuchMethodException</span> <span class="o">{</span>
    <span class="n">Method</span> <span class="n">makeDexElements</span> <span class="o">=</span> <span class="n">MultiDex</span><span class="o">.</span><span class="na">findMethod</span><span class="o">(</span><span class="n">dexPathList</span><span class="o">,</span> <span class="s">"makeDexElements"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">ArrayList</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">File</span><span class="o">.</span><span class="na">class</span><span class="o">});</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">Object</span><span class="o">[])((</span><span class="n">Object</span><span class="o">[])</span><span class="n">makeDexElements</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">dexPathList</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]{</span><span class="n">files</span><span class="o">,</span> <span class="n">optimizedDirectory</span><span class="o">}));</span>
<span class="o">}</span>
</code></pre>
</div>

<p>有空可以看一下dx的<code class="highlighter-rouge">-multi-dex</code>参数是如何拆包的。</p>

<h3 id="instant-run">Instant-run</h3>

<p>和Nuwa一样,也是一个Gradle插件一个<code class="highlighter-rouge">sdk:gradle plugin 2.0.0-alpha1</code>和<code class="highlighter-rouge">instant-run.jar</code>
<code class="highlighter-rouge">instance-run.jar</code>在build期间被打包到apk里面,避免我们自己去compile</p>

<ul>
  <li><code class="highlighter-rouge">hot swap</code>是三种类型中最快生效的，它的可以作用在一般代码的修改上</li>
  <li><code class="highlighter-rouge">warm swap</code>是针对资源的修改，需要你重启对应的Activity。</li>
  <li><code class="highlighter-rouge">cold swap</code>是最慢的一种，它需要你重启整个app，并且需要你的Android API在21或者以上，对于API20以下的，则会和原来一样，重新构建并部署应用。</li>
</ul>

<p><img src="/img/2017-05-02-multidex/14934468299959.jpg" alt="" />
我随便选了个weibo sdk的test工程做了修改,<code class="highlighter-rouge">instant-run</code>后可以看到确实生成了<code class="highlighter-rouge">AppPatchesLoaderImpl</code>和一些<code class="highlighter-rouge">@override</code>文件,至于有三个是因为有一些内部类。</p>

<p><img src="/img/2017-05-02-multidex/14934470238756.jpg" alt="" /></p>

<p><img src="/img/2017-05-02-multidex/14934471773422.jpg" alt="" /></p>

<p><img src="/img/2017-05-02-multidex/14934471953188.jpg" alt="" />
所有方法都被asm注入为以下套路:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>IncrementalChange var2 = $change;
if(var2 != null){
    var2.access$dispatch(...。。)
}else{
    original code
}  
</code></pre>
</div>

<p><img src="/img/2017-05-02-multidex/14934473559925.jpg" alt="" /></p>

<p><img src="/img/2017-05-02-multidex/14934473803670.jpg" alt="" />
这些都是由<code class="highlighter-rouge">plugin</code>通过<code class="highlighter-rouge">transform api</code>实现的。</p>

<h4 id="sdk">sdk</h4>

<p><img src="/img/2017-05-02-multidex/14934474788035.jpg" alt="" /></p>
<h5 id="createresources">createResources</h5>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">createResources</span><span class="o">(</span><span class="kt">long</span> <span class="n">apkModified</span><span class="o">)</span>
  <span class="o">{</span>
   <span class="c1">//"/data/data/" + applicationId + "/files/instant-run/inbox"</span>
    <span class="n">FileManager</span><span class="o">.</span><span class="na">checkInbox</span><span class="o">();</span>
    
    <span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="n">FileManager</span><span class="o">.</span><span class="na">getExternalResourceFile</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">externalResourcePath</span> <span class="o">=</span> <span class="o">(</span><span class="n">file</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">file</span><span class="o">.</span><span class="na">getPath</span><span class="o">()</span> <span class="o">:</span> <span class="kc">null</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">isLoggable</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="s">"Resource override is "</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">externalResourcePath</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">file</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">try</span>
      <span class="o">{</span>
        <span class="kt">long</span> <span class="n">resourceModified</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="na">lastModified</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">isLoggable</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span>
        <span class="o">{</span>
          <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="s">"Resource patch last modified: "</span> <span class="o">+</span> <span class="n">resourceModified</span><span class="o">);</span>
          <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="s">"APK last modified: "</span> <span class="o">+</span> <span class="n">apkModified</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="o">(</span><span class="n">apkModified</span> <span class="o">&gt;</span> <span class="n">resourceModified</span> <span class="o">?</span> <span class="s">"&gt;"</span> <span class="o">:</span> <span class="s">"&lt;"</span><span class="o">)</span> <span class="o">+</span> <span class="s">" resource patch"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">apkModified</span> <span class="o">==</span> <span class="mi">0L</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="n">resourceModified</span> <span class="o">&lt;=</span> <span class="n">apkModified</span><span class="o">))</span>
        <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">isLoggable</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="s">"Ignoring resource file, older than APK"</span><span class="o">);</span>
          <span class="o">}</span>
          <span class="k">this</span><span class="o">.</span><span class="na">externalResourcePath</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span>
      <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="s">"Failed to check patch timestamps"</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
</code></pre>
</div>

<h5 id="setupclassloaders">setupClassLoaders</h5>

<p><a href="http://w4lle.github.io/2016/05/02/从Instant%20run谈Android替换Application和动态加载机制/">非常棒的文章👍</a></p>

<p><img src="/img/2017-05-02-multidex/14934475142698.jpg" alt="" />
再看inject方法:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="n">ClassLoader</span> <span class="nf">inject</span><span class="o">(</span><span class="n">ClassLoader</span> <span class="n">classLoader</span><span class="o">,</span> <span class="n">String</span> <span class="n">nativeLibraryPath</span><span class="o">,</span> <span class="n">String</span> <span class="n">codeCacheDir</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">dexes</span><span class="o">){</span>
    <span class="n">IncrementalClassLoader</span> <span class="n">incrementalClassLoader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IncrementalClassLoader</span><span class="o">(</span><span class="n">classLoader</span><span class="o">,</span> <span class="n">nativeLibraryPath</span><span class="o">,</span> <span class="n">codeCacheDir</span><span class="o">,</span> <span class="n">dexes</span><span class="o">);</span> 
    <span class="n">setParent</span><span class="o">(</span><span class="n">classLoader</span><span class="o">,</span> <span class="n">incrementalClassLoader</span><span class="o">);</span> 
    <span class="k">return</span> <span class="n">incrementalClassLoader</span><span class="o">;</span>
 <span class="o">}</span>
</code></pre>
</div>
<p><code class="highlighter-rouge">BootStrapApplication</code>由<code class="highlighter-rouge">IncrementalClassLoader</code>加载</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">IncrementalClassLoader</span>
  <span class="kd">extends</span> <span class="n">ClassLoader</span>
<span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">DEBUG_CLASS_LOADING</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">DelegateClassLoader</span> <span class="n">delegateClassLoader</span><span class="o">;</span>
  <span class="c1">//cache是optimized dir</span>
  <span class="kd">public</span> <span class="nf">IncrementalClassLoader</span><span class="o">(</span><span class="n">ClassLoader</span> <span class="n">original</span><span class="o">,</span> <span class="n">String</span> <span class="n">nativeLibraryPath</span><span class="o">,</span> <span class="n">String</span> <span class="n">codeCacheDir</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">dexes</span><span class="o">)</span>
  <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">original</span><span class="o">.</span><span class="na">getParent</span><span class="o">());</span>
    <span class="c1">//创建真正的classLoader</span>
    <span class="k">this</span><span class="o">.</span><span class="na">delegateClassLoader</span> <span class="o">=</span> <span class="n">createDelegateClassLoader</span><span class="o">(</span><span class="n">nativeLibraryPath</span><span class="o">,</span> <span class="n">codeCacheDir</span><span class="o">,</span> <span class="n">dexes</span><span class="o">,</span> <span class="n">original</span><span class="o">);</span>
  <span class="o">}</span>
  
  <span class="kd">public</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">findClass</span><span class="o">(</span><span class="n">String</span> <span class="n">className</span><span class="o">)</span>
    <span class="kd">throws</span> <span class="n">ClassNotFoundException</span>
  <span class="o">{</span>
    <span class="k">try</span>
    <span class="o">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">delegateClassLoader</span><span class="o">.</span><span class="na">findClass</span><span class="o">(</span><span class="n">className</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="n">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span>
    <span class="o">{</span>
      <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
  
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">DelegateClassLoader</span>
    <span class="kd">extends</span> <span class="n">BaseDexClassLoader</span>
  <span class="o">{</span>
    <span class="kd">private</span> <span class="nf">DelegateClassLoader</span><span class="o">(</span><span class="n">String</span> <span class="n">dexPath</span><span class="o">,</span> <span class="n">File</span> <span class="n">optimizedDirectory</span><span class="o">,</span> <span class="n">String</span> <span class="n">libraryPath</span><span class="o">,</span> <span class="n">ClassLoader</span> <span class="n">parent</span><span class="o">)</span>
    <span class="o">{</span>
      <span class="kd">super</span><span class="o">(</span><span class="n">optimizedDirectory</span><span class="o">,</span> <span class="n">libraryPath</span><span class="o">,</span> <span class="n">parent</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">findClass</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">ClassNotFoundException</span>
    <span class="o">{</span>
      <span class="k">try</span>
      <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">findClass</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">catch</span> <span class="o">(</span><span class="n">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span>
      <span class="o">{</span>
        <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
  
  <span class="kd">private</span> <span class="kd">static</span> <span class="n">DelegateClassLoader</span> <span class="nf">createDelegateClassLoader</span><span class="o">(</span><span class="n">String</span> <span class="n">nativeLibraryPath</span><span class="o">,</span> <span class="n">String</span> <span class="n">codeCacheDir</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">dexes</span><span class="o">,</span> <span class="n">ClassLoader</span> <span class="n">original</span><span class="o">)</span>
  <span class="o">{</span>
    <span class="n">String</span> <span class="n">pathBuilder</span> <span class="o">=</span> <span class="n">createDexPath</span><span class="o">(</span><span class="n">dexes</span><span class="o">);</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">DelegateClassLoader</span><span class="o">(</span><span class="n">pathBuilder</span><span class="o">,</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">codeCacheDir</span><span class="o">),</span> <span class="n">nativeLibraryPath</span><span class="o">,</span> <span class="n">original</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
  <span class="o">}</span>
  
  <span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">createDexPath</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">dexes</span><span class="o">)</span>
  <span class="o">{</span>
    <span class="n">StringBuilder</span> <span class="n">pathBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
    <span class="kt">boolean</span> <span class="n">first</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">dex</span> <span class="o">:</span> <span class="n">dexes</span><span class="o">)</span>
    <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">first</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">first</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">pathBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">File</span><span class="o">.</span><span class="na">pathSeparator</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">pathBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">dex</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">isLoggable</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="s">"Incremental dex path is "</span> <span class="o">+</span> 
        <span class="n">BootstrapApplication</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="sc">'\n'</span><span class="o">,</span> <span class="n">dexes</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">pathBuilder</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="c1">//设置parent,双亲委派模式</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setParent</span><span class="o">(</span><span class="n">ClassLoader</span> <span class="n">classLoader</span><span class="o">,</span> <span class="n">ClassLoader</span> <span class="n">newParent</span><span class="o">)</span>
  <span class="o">{</span>
    <span class="k">try</span>
    <span class="o">{</span>
      <span class="n">Field</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">ClassLoader</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"parent"</span><span class="o">);</span>
      <span class="n">parent</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
      <span class="n">parent</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">classLoader</span><span class="o">,</span> <span class="n">newParent</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalArgumentException</span> <span class="n">e</span><span class="o">)</span>
    <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span>
    <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchFieldException</span> <span class="n">e</span><span class="o">)</span>
    <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h5 id="dexpath">dexPath</h5>

<p><code class="highlighter-rouge">instant-run</code>会把所有<code class="highlighter-rouge">classes.dex</code>放到一个压缩包里,所以我们要自定义<code class="highlighter-rouge">classloader</code>去解压加载</p>

<p><code class="highlighter-rouge">dexPath</code>是<code class="highlighter-rouge">/data/data/package_name/files/instant-run/dex</code>目录下的dex列表</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code> <span class="kd">public</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">getDexList</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="kt">long</span> <span class="n">apkModified</span><span class="o">)</span>
  <span class="o">{</span>
  <span class="c1">//"/data/data/" + applicationId + "/files/instant-run"</span>
    <span class="n">File</span> <span class="n">dataFolder</span> <span class="o">=</span> <span class="n">getDataFolder</span><span class="o">();</span>
   <span class="c1">//hotSwap回留下临时文件 </span>
    <span class="kt">long</span> <span class="n">newestHotswapPatch</span> <span class="o">=</span> <span class="n">getMostRecentTempDexTime</span><span class="o">(</span><span class="n">dataFolder</span><span class="o">);</span>
    <span class="c1">//dexFolder还没有,那就先创建吧</span>
    <span class="n">File</span> <span class="n">dexFolder</span> <span class="o">=</span> <span class="n">getDexFileFolder</span><span class="o">(</span><span class="n">dataFolder</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
    
    <span class="kt">boolean</span> <span class="n">extractedSlices</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="n">File</span><span class="o">[]</span> <span class="n">dexFiles</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">dexFolder</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">||</span> <span class="o">(!</span><span class="n">dexFolder</span><span class="o">.</span><span class="na">isDirectory</span><span class="o">()))</span>
    <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">isLoggable</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="s">"No local dex slice folder: First run since installation."</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">dexFolder</span> <span class="o">=</span> <span class="n">getDexFileFolder</span><span class="o">(</span><span class="n">dataFolder</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">dexFolder</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
      <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">wtf</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="s">"Couldn't create dex code folder"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="n">File</span><span class="o">[]</span> <span class="n">dexFiles</span> <span class="o">=</span> <span class="n">extractSlices</span><span class="o">(</span><span class="n">dexFolder</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="o">-</span><span class="mi">1L</span><span class="o">);</span>
      <span class="n">extractedSlices</span> <span class="o">=</span> <span class="n">dexFiles</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">else</span>
    <span class="o">{</span>
      <span class="n">dexFiles</span> <span class="o">=</span> <span class="n">dexFolder</span><span class="o">.</span><span class="na">listFiles</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">dexFiles</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="n">dexFiles</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">))</span>
    <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">isLoggable</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="s">"Cannot find dex classes, not patching them in"</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kt">long</span> <span class="n">newestColdswapPatch</span> <span class="o">=</span> <span class="n">apkModified</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">((!</span><span class="n">extractedSlices</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">dexFiles</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">))</span>
    <span class="o">{</span>
      <span class="kt">long</span> <span class="n">oldestColdSwapPatch</span> <span class="o">=</span> <span class="n">apkModified</span><span class="o">;</span>
      <span class="k">for</span> <span class="o">(</span><span class="n">File</span> <span class="n">dex</span> <span class="o">:</span> <span class="n">dexFiles</span><span class="o">)</span>
      <span class="o">{</span>
        <span class="kt">long</span> <span class="n">dexModified</span> <span class="o">=</span> <span class="n">dex</span><span class="o">.</span><span class="na">lastModified</span><span class="o">();</span>
        <span class="n">oldestColdSwapPatch</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">dexModified</span><span class="o">,</span> <span class="n">oldestColdSwapPatch</span><span class="o">);</span>
        <span class="n">newestColdswapPatch</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="n">dexModified</span><span class="o">,</span> <span class="n">newestColdswapPatch</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">oldestColdSwapPatch</span> <span class="o">&lt;</span> <span class="n">apkModified</span><span class="o">)</span>
      <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">isLoggable</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span> <span class="o">{</span>
          <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="s">"One or more slices were older than APK: extracting newer slices"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">//解压instant-run.zip中的dex</span>
        <span class="n">dexFiles</span> <span class="o">=</span> <span class="n">extractSlices</span><span class="o">(</span><span class="n">dexFolder</span><span class="o">,</span> <span class="n">dexFiles</span><span class="o">,</span> <span class="n">apkModified</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">newestHotswapPatch</span> <span class="o">&gt;</span> <span class="mi">0L</span><span class="o">)</span>
    <span class="o">{</span>
      <span class="n">purgeTempDexFiles</span><span class="o">(</span><span class="n">dataFolder</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">newestHotswapPatch</span> <span class="o">&gt;</span> <span class="n">newestColdswapPatch</span><span class="o">)</span>
    <span class="o">{</span>
      <span class="n">String</span> <span class="n">message</span> <span class="o">=</span> <span class="s">"Your app does not have the latest code changes because it was restarted manually. Please run from IDE instead."</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">isLoggable</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">Restarter</span><span class="o">.</span><span class="na">showToastWhenPossible</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">(</span><span class="n">dexFiles</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">File</span> <span class="n">dex</span> <span class="o">:</span> <span class="n">dexFiles</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">dex</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">endsWith</span><span class="o">(</span><span class="s">".dex"</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">dex</span><span class="o">.</span><span class="na">getPath</span><span class="o">());</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">Collections</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">list</span><span class="o">,</span> <span class="n">Collections</span><span class="o">.</span><span class="na">reverseOrder</span><span class="o">());</span>
    
    <span class="k">return</span> <span class="n">list</span><span class="o">;</span>
  <span class="o">}</span>
  
</code></pre>
</div>

<p><img src="/img/2017-05-02-multidex/14935234377075.png" alt="" />
所以前面使用<code class="highlighter-rouge">delegateClassLoader</code>是用来加载这些dex的。</p>

<h5 id="createrealapplication">createRealApplication</h5>

<p><img src="/img/2017-05-02-multidex/14935170794564.jpg" alt="" /></p>

<p>如果用户自定义了<code class="highlighter-rouge">Application</code>,在<code class="highlighter-rouge">Instant-run-bootstrap.jar</code>中,<code class="highlighter-rouge">AppInfo.applicationClass</code>为真实<code class="highlighter-rouge">Application</code>,因此把它赋值给<code class="highlighter-rouge">realApplication</code>变量。</p>

<h4 id="oncreate">onCreate</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(){</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">AppInfo</span><span class="o">.</span><span class="na">usingApkSplits</span><span class="o">){</span>
      <span class="n">MonkeyPatcher</span><span class="o">.</span><span class="na">monkeyPatchApplication</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">realApplication</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">externalResourcePath</span><span class="o">);</span>
      <span class="n">MonkeyPatcher</span><span class="o">.</span><span class="na">monkeyPatchExistingResources</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">externalResourcePath</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span><span class="k">else</span><span class="o">{</span>
      <span class="n">MonkeyPatcher</span><span class="o">.</span><span class="na">monkeyPatchApplication</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">realApplication</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">();</span>
</code></pre>
</div>

<h5 id="monkeypatchermonkeypatchapplication">MonkeyPatcher.monkeyPatchApplication</h5>

<p>很长的函数</p>

<ol>
  <li>把对应的<code class="highlighter-rouge">application</code>替换成我们真正的<code class="highlighter-rouge">applictaion</code>。</li>
  <li>替换资源路径，老的资源路径是<code class="highlighter-rouge">/data/app/[package name]-1.apk</code>，新的资源路径是<code class="highlighter-rouge">/data/data/[applicationId]/files/instant-run/resources.ap_</code>。</li>
  <li>把真正<code class="highlighter-rouge">application</code>的<code class="highlighter-rouge">LoadedApk</code>替换成<code class="highlighter-rouge">BootstrapApplication</code>的，为什么要这么做呢，因为<code class="highlighter-rouge">LoadedApk</code>中持有了<code class="highlighter-rouge">ClassLoader</code>，这样替换以后，我们程序中加载类都会使用<code class="highlighter-rouge">BootstrapApplication</code>的<code class="highlighter-rouge">LoadedApk</code>，从而使用它的<code class="highlighter-rouge">ClassLoader</code>，而在之前我们已经把<code class="highlighter-rouge">ClassLoade</code>的父<code class="highlighter-rouge">loader</code>设置成了<code class="highlighter-rouge">IncrementalClassLoader</code>，绕了这么一大圈，其实就是为了［使用<code class="highlighter-rouge">IncrementalClassLoader</code>去加载类］。</li>
</ol>

<ul>
  <li>替换<code class="highlighter-rouge">ActivityThread</code>的<code class="highlighter-rouge">mInitialApplication</code>为<code class="highlighter-rouge">realApplication</code></li>
  <li>替换<code class="highlighter-rouge">mAllApplications</code> 中所有的<code class="highlighter-rouge">Application</code>为<code class="highlighter-rouge">realApplication</code></li>
</ul>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">monkeyPatchApplication</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">Application</span> <span class="n">bootstrap</span><span class="o">,</span> <span class="n">Application</span> <span class="n">realApplication</span><span class="o">,</span> <span class="n">String</span> <span class="n">externalResourceFile</span><span class="o">){</span>
    <span class="k">try</span><span class="o">{</span>
      <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">activityThread</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"android.app.ActivityThread"</span><span class="o">);</span>
      <span class="n">Object</span> <span class="n">currentActivityThread</span> <span class="o">=</span> <span class="n">getActivityThread</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">activityThread</span><span class="o">);</span>   
      <span class="n">Field</span> <span class="n">mInitialApplication</span> <span class="o">=</span> <span class="n">activityThread</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"mInitialApplication"</span><span class="o">);</span>
      <span class="n">mInitialApplication</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
      <span class="n">Application</span> <span class="n">initialApplication</span> <span class="o">=</span> <span class="o">(</span><span class="n">Application</span><span class="o">)</span><span class="n">mInitialApplication</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">currentActivityThread</span><span class="o">);</span>
      <span class="c1">//设置mInitialApplicaion</span>
      <span class="k">if</span> <span class="o">((</span><span class="n">realApplication</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">initialApplication</span> <span class="o">==</span> <span class="n">bootstrap</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">mInitialApplication</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">currentActivityThread</span><span class="o">,</span> <span class="n">realApplication</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">realApplication</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
      <span class="o">{</span>
        <span class="n">Field</span> <span class="n">mAllApplications</span> <span class="o">=</span> <span class="n">activityThread</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"mAllApplications"</span><span class="o">);</span>
        <span class="n">mAllApplications</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Application</span><span class="o">&gt;</span> <span class="n">allApplications</span> <span class="o">=</span> <span class="o">(</span><span class="n">List</span><span class="o">)</span><span class="n">mAllApplications</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">currentActivityThread</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">allApplications</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">allApplications</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">)</span> <span class="o">==</span> <span class="n">bootstrap</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">allApplications</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">realApplication</span><span class="o">);</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">loadedApkClass</span><span class="o">;</span>
      <span class="k">try</span>
      <span class="o">{</span>
        <span class="n">loadedApkClass</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"android.app.LoadedApk"</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">catch</span> <span class="o">(</span><span class="n">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span>
      <span class="o">{</span>
        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">loadedApkClass</span><span class="o">;</span>
        <span class="n">loadedApkClass</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"android.app.ActivityThread$PackageInfo"</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">Field</span> <span class="n">mApplication</span> <span class="o">=</span> <span class="n">loadedApkClass</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"mApplication"</span><span class="o">);</span>
      <span class="n">mApplication</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
      <span class="n">Field</span> <span class="n">mResDir</span> <span class="o">=</span> <span class="n">loadedApkClass</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"mResDir"</span><span class="o">);</span>
      <span class="n">mResDir</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
      
      <span class="n">Field</span> <span class="n">mLoadedApk</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
      <span class="k">try</span>
      <span class="o">{</span>
        <span class="n">mLoadedApk</span> <span class="o">=</span> <span class="n">Application</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"mLoadedApk"</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchFieldException</span> <span class="n">localNoSuchFieldException</span><span class="o">)</span> <span class="o">{}</span>
      <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">fieldName</span> <span class="o">:</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]</span> <span class="o">{</span> <span class="s">"mPackages"</span><span class="o">,</span> <span class="s">"mResourcePackages"</span> <span class="o">})</span>
      <span class="o">{</span>
        <span class="n">Field</span> <span class="n">field</span> <span class="o">=</span> <span class="n">activityThread</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="n">fieldName</span><span class="o">);</span>
        <span class="n">field</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">currentActivityThread</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">WeakReference</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="o">((</span><span class="n">Map</span><span class="o">)</span><span class="n">value</span><span class="o">).</span><span class="na">entrySet</span><span class="o">())</span>
        <span class="o">{</span>
          <span class="n">Object</span> <span class="n">loadedApk</span> <span class="o">=</span> <span class="o">((</span><span class="n">WeakReference</span><span class="o">)</span><span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">()).</span><span class="na">get</span><span class="o">();</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">loadedApk</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mApplication</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">loadedApk</span><span class="o">)</span> <span class="o">==</span> <span class="n">bootstrap</span><span class="o">)</span>
            <span class="o">{</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">realApplication</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">mApplication</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">loadedApk</span><span class="o">,</span> <span class="n">realApplication</span><span class="o">);</span>
              <span class="o">}</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">externalResourceFile</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">mResDir</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">loadedApk</span><span class="o">,</span> <span class="n">externalResourceFile</span><span class="o">);</span>
              <span class="o">}</span>
              <span class="cm">/**
              由于BootstrapApplication在attachBaseContext方法中就将其已经替换为了IncrementalClassLoader，所以代码4处反射将BootstrapApplication的mLoadedApk赋值给了MyApplication，那么接下来MyApplication的所有类的加载都将由IncrementalClassLoader来负责。
              **/</span>
              <span class="k">if</span> <span class="o">((</span><span class="n">realApplication</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">mLoadedApk</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">mLoadedApk</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">realApplication</span><span class="o">,</span> <span class="n">loadedApk</span><span class="o">);</span>
              <span class="o">}</span>
            <span class="o">}</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span>
    <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
</code></pre>
</div>

<p><img src="/img/2017-05-02-multidex/14935174812314.jpg" alt="" /></p>

<p>首先直接获取<code class="highlighter-rouge">ActivityThread.currentActivityThread</code>,如果获取不到从<code class="highlighter-rouge">mLoadedApk.mActivityThread</code>中获取</p>

<blockquote>
  <p>Instant run的重启更新机制更像保守方案即单ClassLoader方案，首先，该种方案只有一个ClassLoader，只不过是通过替换Application达到的替换mLoadedApk进而替换ClassLoader的目的，并没有涉及到缓存mPackage然后dexList也是它自己维护的。</p>
</blockquote>

<h5 id="monkeypatchexistingresources-todo">MonkeyPatchExistingResources todo</h5>

<ul>
  <li>如果<code class="highlighter-rouge">resource.ap_</code>文件有改变，那么新建一个<code class="highlighter-rouge">AssetManager</code>对象<code class="highlighter-rouge">newAssetManager</code>，然后用<code class="highlighter-rouge">newAssetManager</code>对象替换所有当前<code class="highlighter-rouge">Resource、Resource.Theme</code>的<code class="highlighter-rouge">mAssets</code>成员变量。</li>
  <li>如果当前的已经有<code class="highlighter-rouge">Activity</code>启动了，还需要替换所有<code class="highlighter-rouge">Activity</code>中<code class="highlighter-rouge">mAssets</code>成员变量</li>
</ul>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">monkeyPatchExistingResources</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">String</span> <span class="n">externalResourceFile</span><span class="o">,</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Activity</span><span class="o">&gt;</span> <span class="n">activities</span><span class="o">)</span>
  <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">externalResourceFile</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">try</span>
    <span class="o">{</span>
      <span class="n">newAssetManager</span> <span class="o">=</span> <span class="o">(</span><span class="n">AssetManager</span><span class="o">)</span><span class="n">AssetManager</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getConstructor</span><span class="o">(</span><span class="k">new</span> <span class="n">Class</span><span class="o">[</span><span class="mi">0</span><span class="o">]).</span><span class="na">newInstance</span><span class="o">(</span><span class="k">new</span> <span class="n">Object</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
      <span class="c1">//设置AssetManager新的assetPath为externalResourceFile</span>
      <span class="n">Method</span> <span class="n">mAddAssetPath</span> <span class="o">=</span> <span class="n">AssetManager</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"addAssetPath"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]</span> <span class="o">{</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span> <span class="o">});</span>
      <span class="n">mAddAssetPath</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(((</span><span class="n">Integer</span><span class="o">)</span><span class="n">mAddAssetPath</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">newAssetManager</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]</span> <span class="o">{</span> <span class="n">externalResourceFile</span> <span class="o">})).</span><span class="na">intValue</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">"Could not create new AssetManager"</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">Method</span> <span class="n">mEnsureStringBlocks</span> <span class="o">=</span> <span class="n">AssetManager</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"ensureStringBlocks"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
      <span class="n">mEnsureStringBlocks</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
      <span class="n">mEnsureStringBlocks</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">newAssetManager</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">activities</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Activity</span> <span class="n">activity</span> <span class="o">:</span> <span class="n">activities</span><span class="o">)</span>
        <span class="o">{</span>
          <span class="n">Resources</span> <span class="n">resources</span> <span class="o">=</span> <span class="n">activity</span><span class="o">.</span><span class="na">getResources</span><span class="o">();</span>
          <span class="k">try</span>
          <span class="o">{</span>
            <span class="n">Field</span> <span class="n">mAssets</span> <span class="o">=</span> <span class="n">Resources</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"mAssets"</span><span class="o">);</span>
            <span class="n">mAssets</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="n">mAssets</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">resources</span><span class="o">,</span> <span class="n">newAssetManager</span><span class="o">);</span>
          <span class="o">}</span>
          <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">ignore</span><span class="o">)</span>
          <span class="o">{</span>
            <span class="n">Field</span> <span class="n">mResourcesImpl</span> <span class="o">=</span> <span class="n">Resources</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"mResourcesImpl"</span><span class="o">);</span>
            <span class="n">mResourcesImpl</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="n">Object</span> <span class="n">resourceImpl</span> <span class="o">=</span> <span class="n">mResourcesImpl</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">resources</span><span class="o">);</span>
            <span class="n">Field</span> <span class="n">implAssets</span> <span class="o">=</span> <span class="n">resourceImpl</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"mAssets"</span><span class="o">);</span>
            <span class="n">implAssets</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="n">implAssets</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">resourceImpl</span><span class="o">,</span> <span class="n">newAssetManager</span><span class="o">);</span>
          <span class="o">}</span>
          <span class="n">Resources</span><span class="o">.</span><span class="na">Theme</span> <span class="n">theme</span> <span class="o">=</span> <span class="n">activity</span><span class="o">.</span><span class="na">getTheme</span><span class="o">();</span>
          <span class="k">try</span>
          <span class="o">{</span>
            <span class="k">try</span>
            <span class="o">{</span>
              <span class="n">Field</span> <span class="n">ma</span> <span class="o">=</span> <span class="n">Resources</span><span class="o">.</span><span class="na">Theme</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"mAssets"</span><span class="o">);</span>
              <span class="n">ma</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
              <span class="n">ma</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">theme</span><span class="o">,</span> <span class="n">newAssetManager</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchFieldException</span> <span class="n">ignore</span><span class="o">)</span>
            <span class="o">{</span>
              <span class="n">Field</span> <span class="n">themeField</span> <span class="o">=</span> <span class="n">Resources</span><span class="o">.</span><span class="na">Theme</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"mThemeImpl"</span><span class="o">);</span>
              <span class="n">themeField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
              <span class="n">Object</span> <span class="n">impl</span> <span class="o">=</span> <span class="n">themeField</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">theme</span><span class="o">);</span>
              <span class="n">Field</span> <span class="n">ma</span> <span class="o">=</span> <span class="n">impl</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"mAssets"</span><span class="o">);</span>
              <span class="n">ma</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
              <span class="n">ma</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">impl</span><span class="o">,</span> <span class="n">newAssetManager</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">Field</span> <span class="n">mt</span> <span class="o">=</span> <span class="n">ContextThemeWrapper</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"mTheme"</span><span class="o">);</span>
            <span class="n">mt</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="n">mt</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">activity</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
            <span class="n">Method</span> <span class="n">mtm</span> <span class="o">=</span> <span class="n">ContextThemeWrapper</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"initializeTheme"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
            <span class="n">mtm</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="n">mtm</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">activity</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">Build</span><span class="o">.</span><span class="na">VERSION</span><span class="o">.</span><span class="na">SDK_INT</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="o">)</span>
            <span class="o">{</span>
              <span class="n">Method</span> <span class="n">mCreateTheme</span> <span class="o">=</span> <span class="n">AssetManager</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"createTheme"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
              <span class="n">mCreateTheme</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
              <span class="n">Object</span> <span class="n">internalTheme</span> <span class="o">=</span> <span class="n">mCreateTheme</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">newAssetManager</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
              <span class="n">Field</span> <span class="n">mTheme</span> <span class="o">=</span> <span class="n">Resources</span><span class="o">.</span><span class="na">Theme</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"mTheme"</span><span class="o">);</span>
              <span class="n">mTheme</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
              <span class="n">mTheme</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">theme</span><span class="o">,</span> <span class="n">internalTheme</span><span class="o">);</span>
            <span class="o">}</span>
          <span class="o">}</span>
          <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span>
          <span class="o">{</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="s">"Failed to update existing theme for activity "</span> <span class="o">+</span> <span class="n">activity</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
          <span class="o">}</span>
          <span class="n">pruneResourceCaches</span><span class="o">(</span><span class="n">resources</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="n">Object</span> <span class="n">references</span><span class="o">;</span>
      <span class="n">Object</span> <span class="n">references</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">Build</span><span class="o">.</span><span class="na">VERSION</span><span class="o">.</span><span class="na">SDK_INT</span> <span class="o">&gt;=</span> <span class="mi">19</span><span class="o">)</span>
      <span class="o">{</span>
        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">resourcesManagerClass</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"android.app.ResourcesManager"</span><span class="o">);</span>
        <span class="n">Method</span> <span class="n">mGetInstance</span> <span class="o">=</span> <span class="n">resourcesManagerClass</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"getInstance"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
        <span class="n">mGetInstance</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">Object</span> <span class="n">resourcesManager</span> <span class="o">=</span> <span class="n">mGetInstance</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
        <span class="k">try</span>
        <span class="o">{</span>
          <span class="n">Field</span> <span class="n">fMActiveResources</span> <span class="o">=</span> <span class="n">resourcesManagerClass</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"mActiveResources"</span><span class="o">);</span>
          <span class="n">fMActiveResources</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
          
          <span class="n">ArrayMap</span><span class="o">&lt;?,</span> <span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">Resources</span><span class="o">&gt;&gt;</span> <span class="n">arrayMap</span> <span class="o">=</span> <span class="o">(</span><span class="n">ArrayMap</span><span class="o">)</span><span class="n">fMActiveResources</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">resourcesManager</span><span class="o">);</span>
          <span class="n">references</span> <span class="o">=</span> <span class="n">arrayMap</span><span class="o">.</span><span class="na">values</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchFieldException</span> <span class="n">ignore</span><span class="o">)</span>
        <span class="o">{</span>
          <span class="n">Object</span> <span class="n">references</span><span class="o">;</span>
          <span class="n">Field</span> <span class="n">mResourceReferences</span> <span class="o">=</span> <span class="n">resourcesManagerClass</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"mResourceReferences"</span><span class="o">);</span>
          <span class="n">mResourceReferences</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
          
          <span class="n">references</span> <span class="o">=</span> <span class="o">(</span><span class="n">Collection</span><span class="o">)</span><span class="n">mResourceReferences</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">resourcesManager</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="k">else</span>
      <span class="o">{</span>
        <span class="n">activityThread</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"android.app.ActivityThread"</span><span class="o">);</span>
        <span class="n">Field</span> <span class="n">fMActiveResources</span> <span class="o">=</span> <span class="n">activityThread</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"mActiveResources"</span><span class="o">);</span>
        <span class="n">fMActiveResources</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">Object</span> <span class="n">thread</span> <span class="o">=</span> <span class="n">getActivityThread</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">activityThread</span><span class="o">);</span>
        
        <span class="n">HashMap</span><span class="o">&lt;?,</span> <span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">Resources</span><span class="o">&gt;&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="o">(</span><span class="n">HashMap</span><span class="o">)</span><span class="n">fMActiveResources</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">thread</span><span class="o">);</span>
        <span class="n">references</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">values</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="k">for</span> <span class="o">(</span><span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">Resources</span><span class="o">&gt;</span> <span class="n">wr</span> <span class="o">:</span> <span class="o">(</span><span class="n">Collection</span><span class="o">)</span><span class="n">references</span><span class="o">)</span>
      <span class="o">{</span>
        <span class="n">Resources</span> <span class="n">resources</span> <span class="o">=</span> <span class="o">(</span><span class="n">Resources</span><span class="o">)</span><span class="n">wr</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">resources</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
        <span class="o">{</span>
          <span class="k">try</span>
          <span class="o">{</span>
            <span class="n">Field</span> <span class="n">mAssets</span> <span class="o">=</span> <span class="n">Resources</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"mAssets"</span><span class="o">);</span>
            <span class="n">mAssets</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="n">mAssets</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">resources</span><span class="o">,</span> <span class="n">newAssetManager</span><span class="o">);</span>
          <span class="o">}</span>
          <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">ignore</span><span class="o">)</span>
          <span class="o">{</span>
            <span class="n">Field</span> <span class="n">mResourcesImpl</span> <span class="o">=</span> <span class="n">Resources</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"mResourcesImpl"</span><span class="o">);</span>
            <span class="n">mResourcesImpl</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="n">Object</span> <span class="n">resourceImpl</span> <span class="o">=</span> <span class="n">mResourcesImpl</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">resources</span><span class="o">);</span>
            <span class="n">Field</span> <span class="n">implAssets</span> <span class="o">=</span> <span class="n">resourceImpl</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"mAssets"</span><span class="o">);</span>
            <span class="n">implAssets</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="n">implAssets</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">resourceImpl</span><span class="o">,</span> <span class="n">newAssetManager</span><span class="o">);</span>
          <span class="o">}</span>
          <span class="n">resources</span><span class="o">.</span><span class="na">updateConfiguration</span><span class="o">(</span><span class="n">resources</span><span class="o">.</span><span class="na">getConfiguration</span><span class="o">(),</span> <span class="n">resources</span><span class="o">.</span><span class="na">getDisplayMetrics</span><span class="o">());</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span>
    <span class="o">{</span>
      <span class="n">AssetManager</span> <span class="n">newAssetManager</span><span class="o">;</span>
      <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">activityThread</span><span class="o">;</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
</code></pre>
</div>

<p>太长了,先随便看看,等分析完资源再回头看吧</p>

<h4 id="oncreate-1">onCreate</h4>

<p>继续看onCreate:启动server与AS交互</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">AppInfo</span><span class="o">.</span><span class="na">applicationId</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">try</span>
      <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">foundPackage</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">Process</span><span class="o">.</span><span class="na">myPid</span><span class="o">();</span>
        <span class="n">ActivityManager</span> <span class="n">manager</span> <span class="o">=</span> <span class="o">(</span><span class="n">ActivityManager</span><span class="o">)</span><span class="n">getSystemService</span><span class="o">(</span><span class="s">"activity"</span><span class="o">);</span>
        
        <span class="n">List</span><span class="o">&lt;</span><span class="n">ActivityManager</span><span class="o">.</span><span class="na">RunningAppProcessInfo</span><span class="o">&gt;</span> <span class="n">processes</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="na">getRunningAppProcesses</span><span class="o">();</span>
        <span class="kt">boolean</span> <span class="n">startServer</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">processes</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">processes</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">))</span>
        <span class="o">{</span>
          <span class="kt">boolean</span> <span class="n">startServer</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
          <span class="k">for</span> <span class="o">(</span><span class="n">ActivityManager</span><span class="o">.</span><span class="na">RunningAppProcessInfo</span> <span class="n">processInfo</span> <span class="o">:</span> <span class="n">processes</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">AppInfo</span><span class="o">.</span><span class="na">applicationId</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">processInfo</span><span class="o">.</span><span class="na">processName</span><span class="o">))</span>
            <span class="o">{</span>
              <span class="n">foundPackage</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">processInfo</span><span class="o">.</span><span class="na">pid</span> <span class="o">==</span> <span class="n">pid</span><span class="o">)</span>
              <span class="o">{</span>
                <span class="n">startServer</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                <span class="k">break</span><span class="o">;</span>
              <span class="o">}</span>
            <span class="o">}</span>
          <span class="o">}</span>
          <span class="k">if</span> <span class="o">((!</span><span class="n">startServer</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(!</span><span class="n">foundPackage</span><span class="o">))</span>
          <span class="o">{</span>
            <span class="n">startServer</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">isLoggable</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span> <span class="o">{</span>
              <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="s">"Multiprocess but didn't find process with package: starting server anyway"</span><span class="o">);</span>
            <span class="o">}</span>
          <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">else</span>
        <span class="o">{</span>
          <span class="n">startServer</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">startServer</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">Server</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">AppInfo</span><span class="o">.</span><span class="na">applicationId</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span>
      <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">isLoggable</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span> <span class="o">{</span>
          <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="s">"Failed during multi process check"</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">Server</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">AppInfo</span><span class="o">.</span><span class="na">applicationId</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">//调用OnCreate</span>
    <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">realApplication</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">realApplication</span><span class="o">.</span><span class="na">onCreate</span><span class="o">();</span>
    <span class="o">}</span>
</code></pre>
</div>

<h4 id="server">Server</h4>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="k">this</span><span class="o">.</span><span class="na">mServerSocket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LocalServerSocket</span><span class="o">(</span><span class="n">packageName</span><span class="o">);</span>
<span class="n">startServer</span><span class="o">();</span>
</code></pre>
</div>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">Thread</span> <span class="n">socketServerThread</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="k">new</span> <span class="n">SocketServerThread</span><span class="o">(</span><span class="kc">null</span><span class="o">));</span>
<span class="n">socketServerThread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</code></pre>
</div>

<h5 id="socketserverthread">socketServerThread</h5>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span>
    <span class="o">{</span>
      <span class="k">try</span>
      <span class="o">{</span>
        <span class="k">for</span> <span class="o">(;;)</span>
        <span class="o">{</span>
          <span class="n">LocalServerSocket</span> <span class="n">serverSocket</span> <span class="o">=</span> <span class="n">Server</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">mServerSocket</span><span class="o">;</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">serverSocket</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">break</span><span class="o">;</span>
          <span class="o">}</span>
          <span class="c1">//接受来自AS的连接</span>
          <span class="n">LocalSocket</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">serverSocket</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">isLoggable</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="s">"Received connection from IDE: spawning connection thread"</span><span class="o">);</span>
          <span class="o">}</span>
          <span class="n">Server</span><span class="o">.</span><span class="na">SocketServerReplyThread</span> <span class="n">socketServerReplyThread</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Server</span><span class="o">.</span><span class="na">SocketServerReplyThread</span><span class="o">(</span><span class="n">Server</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="n">socket</span><span class="o">);</span>
          
          <span class="n">socketServerReplyThread</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">Server</span><span class="o">.</span><span class="na">sWrongTokenCount</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="o">)</span>
          <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">isLoggable</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span> <span class="o">{</span>
              <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="s">"Stopping server: too many wrong token connections"</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">Server</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">mServerSocket</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="k">break</span><span class="o">;</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span>
      <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">isLoggable</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span> <span class="o">{</span>
          <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="s">"Fatal error accepting connection on local socket"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<p>在<code class="highlighter-rouge">reply</code>中进行回复:<code class="highlighter-rouge">socket</code>开启后，开始读取数据，当读到1时，获取代码变化的<code class="highlighter-rouge">ApplicationPatch</code>列表，然后调用<code class="highlighter-rouge">handlePatches</code>来处理代码的变化。</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="n">DataInputStream</span> <span class="n">input</span><span class="o">,</span> <span class="n">DataOutputStream</span> <span class="n">output</span><span class="o">)</span>
      <span class="kd">throws</span> <span class="n">IOException</span>
    <span class="o">{</span>
      <span class="kt">long</span> <span class="n">magic</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">readLong</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">magic</span> <span class="o">!=</span> <span class="mi">890269988L</span><span class="o">)</span>
      <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="s">"Unrecognized header format "</span> <span class="o">+</span> 
          <span class="n">Long</span><span class="o">.</span><span class="na">toHexString</span><span class="o">(</span><span class="n">magic</span><span class="o">));</span>
        <span class="k">return</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="kt">int</span> <span class="n">version</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
      
      <span class="n">output</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="mi">4</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">version</span> <span class="o">!=</span> <span class="mi">4</span><span class="o">)</span>
      <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="s">"Mismatched protocol versions; app is using version 4 and tool is using version "</span> <span class="o">+</span> <span class="n">version</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">else</span>
      <span class="o">{</span>
        <span class="kt">int</span> <span class="n">message</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(;;)</span>
        <span class="o">{</span>
          <span class="n">message</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
          <span class="k">switch</span> <span class="o">(</span><span class="n">message</span><span class="o">)</span>
          <span class="o">{</span>
          <span class="k">case</span> <span class="mi">7</span><span class="o">:</span> 
            <span class="k">if</span> <span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">isLoggable</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span> <span class="o">{</span>
              <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="s">"Received EOF from the IDE"</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span><span class="o">;</span>
          <span class="k">case</span> <span class="mi">2</span><span class="o">:</span> 
            <span class="kt">boolean</span> <span class="n">active</span> <span class="o">=</span> <span class="n">Restarter</span><span class="o">.</span><span class="na">getForegroundActivity</span><span class="o">(</span><span class="n">Server</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">mApplication</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">output</span><span class="o">.</span><span class="na">writeBoolean</span><span class="o">(</span><span class="n">active</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">isLoggable</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span> <span class="o">{</span>
              <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="s">"Received Ping message from the IDE; returned active = "</span> <span class="o">+</span> <span class="n">active</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">break</span><span class="o">;</span>
          <span class="k">case</span> <span class="mi">3</span><span class="o">:</span> 
            <span class="n">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">readUTF</span><span class="o">();</span>
            <span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="n">FileManager</span><span class="o">.</span><span class="na">getFileSize</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
            <span class="n">output</span><span class="o">.</span><span class="na">writeLong</span><span class="o">(</span><span class="n">size</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">isLoggable</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span> <span class="o">{</span>
              <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="s">"Received path-exists("</span> <span class="o">+</span> <span class="n">path</span> <span class="o">+</span> <span class="s">") from the "</span> <span class="o">+</span> <span class="s">"IDE; returned size="</span> <span class="o">+</span> <span class="n">size</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">break</span><span class="o">;</span>
          <span class="k">case</span> <span class="mi">4</span><span class="o">:</span> 
            <span class="kt">long</span> <span class="n">begin</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
            <span class="n">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">readUTF</span><span class="o">();</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">checksum</span> <span class="o">=</span> <span class="n">FileManager</span><span class="o">.</span><span class="na">getCheckSum</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">checksum</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
            <span class="o">{</span>
              <span class="n">output</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">checksum</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
              <span class="n">output</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">checksum</span><span class="o">);</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">isLoggable</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span>
              <span class="o">{</span>
                <span class="kt">long</span> <span class="n">end</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
                <span class="n">String</span> <span class="n">hash</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BigInteger</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">checksum</span><span class="o">).</span><span class="na">toString</span><span class="o">(</span><span class="mi">16</span><span class="o">);</span>
                <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="s">"Received checksum("</span> <span class="o">+</span> <span class="n">path</span> <span class="o">+</span> <span class="s">") from the "</span> <span class="o">+</span> <span class="s">"IDE: took "</span> <span class="o">+</span> <span class="o">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">begin</span><span class="o">)</span> <span class="o">+</span> <span class="s">"ms to compute "</span> <span class="o">+</span> <span class="n">hash</span><span class="o">);</span>
              <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">else</span>
            <span class="o">{</span>
              <span class="n">output</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">isLoggable</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="s">"Received checksum("</span> <span class="o">+</span> <span class="n">path</span> <span class="o">+</span> <span class="s">") from the "</span> <span class="o">+</span> <span class="s">"IDE: returning &lt;null&gt;"</span><span class="o">);</span>
              <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">break</span><span class="o">;</span>
          <span class="k">case</span> <span class="mi">5</span><span class="o">:</span> 
            <span class="k">if</span> <span class="o">(!</span><span class="n">authenticate</span><span class="o">(</span><span class="n">input</span><span class="o">))</span> <span class="o">{</span>
              <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">Activity</span> <span class="n">activity</span> <span class="o">=</span> <span class="n">Restarter</span><span class="o">.</span><span class="na">getForegroundActivity</span><span class="o">(</span><span class="n">Server</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">mApplication</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">activity</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
            <span class="o">{</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">isLoggable</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="s">"Restarting activity per user request"</span><span class="o">);</span>
              <span class="o">}</span>
              <span class="n">Restarter</span><span class="o">.</span><span class="na">restartActivityOnUiThread</span><span class="o">(</span><span class="n">activity</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">break</span><span class="o">;</span>
          <span class="k">case</span> <span class="mi">1</span><span class="o">:</span> 
            <span class="k">if</span> <span class="o">(!</span><span class="n">authenticate</span><span class="o">(</span><span class="n">input</span><span class="o">))</span> <span class="o">{</span>
              <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">ApplicationPatch</span><span class="o">&gt;</span> <span class="n">changes</span> <span class="o">=</span> <span class="n">ApplicationPatch</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">input</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">changes</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
            <span class="o">{</span>
              <span class="kt">boolean</span> <span class="n">hasResources</span> <span class="o">=</span> <span class="n">Server</span><span class="o">.</span><span class="na">hasResources</span><span class="o">(</span><span class="n">changes</span><span class="o">);</span>
              <span class="kt">int</span> <span class="n">updateMode</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
              <span class="n">updateMode</span> <span class="o">=</span> <span class="n">Server</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">handlePatches</span><span class="o">(</span><span class="n">changes</span><span class="o">,</span> <span class="n">hasResources</span><span class="o">,</span> <span class="n">updateMode</span><span class="o">);</span>
              
              <span class="kt">boolean</span> <span class="n">showToast</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">readBoolean</span><span class="o">();</span>
              
              <span class="n">output</span><span class="o">.</span><span class="na">writeBoolean</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
              
              <span class="n">Server</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">restart</span><span class="o">(</span><span class="n">updateMode</span><span class="o">,</span> <span class="n">hasResources</span><span class="o">,</span> <span class="n">showToast</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">break</span><span class="o">;</span>
          <span class="k">case</span> <span class="mi">6</span><span class="o">:</span> 
            <span class="n">String</span> <span class="n">text</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">readUTF</span><span class="o">();</span>
            <span class="n">Activity</span> <span class="n">foreground</span> <span class="o">=</span> <span class="n">Restarter</span><span class="o">.</span><span class="na">getForegroundActivity</span><span class="o">(</span><span class="n">Server</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">mApplication</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">foreground</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">Restarter</span><span class="o">.</span><span class="na">showToast</span><span class="o">(</span><span class="n">foreground</span><span class="o">,</span> <span class="n">text</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">isLoggable</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span> <span class="o">{</span>
              <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="s">"Couldn't show toast (no activity) : "</span> <span class="o">+</span> <span class="n">text</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">break</span><span class="o">;</span>
          <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">isLoggable</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="mi">6</span><span class="o">))</span> <span class="o">{</span>
          <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="s">"Unexpected message type: "</span> <span class="o">+</span> <span class="n">message</span><span class="o">);</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<h5 id="handlepatches">handlePatches</h5>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>  <span class="kd">private</span> <span class="kt">int</span> <span class="nf">handlePatches</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">ApplicationPatch</span><span class="o">&gt;</span> <span class="n">changes</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">hasResources</span><span class="o">,</span> <span class="kt">int</span> <span class="n">updateMode</span><span class="o">)</span>
  <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">hasResources</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">FileManager</span><span class="o">.</span><span class="na">startUpdate</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">//根据文件后缀名进行patch的选择</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">ApplicationPatch</span> <span class="n">change</span> <span class="o">:</span> <span class="n">changes</span><span class="o">)</span>
    <span class="o">{</span>
      <span class="n">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">change</span><span class="o">.</span><span class="na">getPath</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">path</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s">".dex"</span><span class="o">))</span>
      <span class="o">{</span>
        <span class="n">handleColdSwapPatch</span><span class="o">(</span><span class="n">change</span><span class="o">);</span>
        
        <span class="kt">boolean</span> <span class="n">canHotSwap</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">ApplicationPatch</span> <span class="n">c</span> <span class="o">:</span> <span class="n">changes</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="na">getPath</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"classes.dex.3"</span><span class="o">))</span>
          <span class="o">{</span>
            <span class="n">canHotSwap</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="k">break</span><span class="o">;</span>
          <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">canHotSwap</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">updateMode</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">path</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"classes.dex.3"</span><span class="o">))</span>
      <span class="o">{</span>
        <span class="n">updateMode</span> <span class="o">=</span> <span class="n">handleHotSwapPatch</span><span class="o">(</span><span class="n">updateMode</span><span class="o">,</span> <span class="n">change</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">isResourcePath</span><span class="o">(</span><span class="n">path</span><span class="o">))</span>
      <span class="o">{</span>
        <span class="n">updateMode</span> <span class="o">=</span> <span class="n">handleResourcePatch</span><span class="o">(</span><span class="n">updateMode</span><span class="o">,</span> <span class="n">change</span><span class="o">,</span> <span class="n">path</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">hasResources</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">FileManager</span><span class="o">.</span><span class="na">finishUpdate</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">updateMode</span><span class="o">;</span>
  <span class="o">}</span>
</code></pre>
</div>

<h5 id="hotpatches">hotPatches</h5>

<p>是通过dexPath创建一个ClassLoader，并且通过它去创建一个AppPatchesLoaderImpl，然后执行AppPatchesLoaderImpl的load方法。AppPatchesLoaderImpl这个类大家还记得吧，就是之前的那个［记录类］。</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code> <span class="k">try</span>
    <span class="o">{</span>
      <span class="n">String</span> <span class="n">dexFile</span> <span class="o">=</span> <span class="n">FileManager</span><span class="o">.</span><span class="na">writeTempDexFile</span><span class="o">(</span><span class="n">patch</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">dexFile</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
      <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="s">"No file to write the code to"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">updateMode</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">isLoggable</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="s">"Reading live code from "</span> <span class="o">+</span> <span class="n">dexFile</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">String</span> <span class="n">nativeLibraryPath</span> <span class="o">=</span> <span class="n">FileManager</span><span class="o">.</span><span class="na">getNativeLibraryFolder</span><span class="o">().</span><span class="na">getPath</span><span class="o">();</span>
      <span class="c1">//这里的dexFile是patch的dex..AS给应用的,包含$override文件</span>
      <span class="n">DexClassLoader</span> <span class="n">dexClassLoader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DexClassLoader</span><span class="o">(</span><span class="n">dexFile</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">mApplication</span><span class="o">.</span><span class="na">getCacheDir</span><span class="o">().</span><span class="na">getPath</span><span class="o">(),</span> <span class="n">nativeLibraryPath</span><span class="o">,</span> <span class="n">getClass</span><span class="o">().</span><span class="na">getClassLoader</span><span class="o">());</span>
      <span class="c1">////加载AppPatchesLoaderImpl类，初始化，执行load方法,注意这里新创建了一个classLoader区加载这个类</span>
      <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">aClass</span> <span class="o">=</span> <span class="n">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"com.android.tools.fd.runtime.AppPatchesLoaderImpl"</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">dexClassLoader</span><span class="o">);</span>
      <span class="k">try</span>
      <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">isLoggable</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span> <span class="o">{</span>
          <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="s">"Got the patcher class "</span> <span class="o">+</span> <span class="n">aClass</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">PatchesLoader</span> <span class="n">loader</span> <span class="o">=</span> <span class="o">(</span><span class="n">PatchesLoader</span><span class="o">)</span><span class="n">aClass</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">isLoggable</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span> <span class="o">{</span>
          <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="s">"Got the patcher instance "</span> <span class="o">+</span> <span class="n">loader</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">String</span><span class="o">[]</span> <span class="n">getPatchedClasses</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">[])</span><span class="n">aClass</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">"getPatchedClasses"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[</span><span class="mi">0</span><span class="o">]).</span><span class="na">invoke</span><span class="o">(</span><span class="n">loader</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">isLoggable</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span>
        <span class="o">{</span>
          <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="s">"Got the list of classes "</span><span class="o">);</span>
          <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">getPatchedClass</span> <span class="o">:</span> <span class="n">getPatchedClasses</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="s">"class "</span> <span class="o">+</span> <span class="n">getPatchedClass</span><span class="o">);</span>
          <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">loader</span><span class="o">.</span><span class="na">load</span><span class="o">())</span> <span class="o">{</span>
          <span class="n">updateMode</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span>
      <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="s">"Couldn't apply code changes"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="n">updateMode</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span>
</code></pre>
</div>

<blockquote>
  <p>Instant run热更新是多ClassLoader加载方案，每个插件dex都有一个ClassLoader，如果插件需要升级，直接重新创建一个自定的ClassLoader加载新的插件。但是目前来看，Instant run修改java代码大部分情况下都是重启更新机制，可能热更新机制还有bug。资源更新是热更新，重启对应Activity就可以。</p>
</blockquote>

<p><img src="/img/2017-05-02-multidex/14935318889556.jpg" alt="" /></p>

<h5 id="coldpatches">ColdPatches</h5>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">handleColdSwapPatch</span><span class="o">(</span><span class="n">ApplicationPatch</span> <span class="n">patch</span><span class="o">){</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">patch</span><span class="o">.</span><span class="na">path</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"slice-"</span><span class="o">)){</span>
      <span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="n">FileManager</span><span class="o">.</span><span class="na">writeDexShard</span><span class="o">(</span><span class="n">patch</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="n">patch</span><span class="o">.</span><span class="na">path</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">isLoggable</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="s">"Received dex shard "</span> <span class="o">+</span> <span class="n">file</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">File</span> <span class="nf">writeDexShard</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">)</span>
  <span class="o">{</span>
    <span class="c1">//可以看到就是写到之前解压instant-run.zip的文件夹中去</span>
    <span class="n">File</span> <span class="n">dexFolder</span> <span class="o">=</span> <span class="n">getDexFileFolder</span><span class="o">(</span><span class="n">getDataFolder</span><span class="o">(),</span> <span class="kc">true</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">dexFolder</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">dexFolder</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>
    <span class="n">writeRawBytes</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="n">bytes</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">file</span><span class="o">;</span>
  <span class="o">}</span>
</code></pre>
</div>

<p>把dex文件写到私有目录，等待整个app重启，重启之后，使用前面提到的IncrementalClassLoader加载dex即可。</p>

<h5 id="资源patch">资源patch</h5>

<p>直接写资源文件吧？？</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code>  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">handleResourcePatch</span><span class="o">(</span><span class="kt">int</span> <span class="n">updateMode</span><span class="o">,</span> <span class="n">ApplicationPatch</span> <span class="n">patch</span><span class="o">,</span> <span class="n">String</span> <span class="n">path</span><span class="o">)</span>
  <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">isLoggable</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="mi">2</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">Log</span><span class="o">.</span><span class="na">v</span><span class="o">(</span><span class="s">"InstantRun"</span><span class="o">,</span> <span class="s">"Received resource changes ("</span> <span class="o">+</span> <span class="n">path</span> <span class="o">+</span> <span class="s">")"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">FileManager</span><span class="o">.</span><span class="na">writeAaptResources</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">patch</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
    
    <span class="n">updateMode</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="n">updateMode</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">updateMode</span><span class="o">;</span>
  <span class="o">}</span>
  
</code></pre>
</div>

<h4 id="abstractpatchesloaderimpl">AbstractPatchesLoaderImpl</h4>

<h5 id="load-1">load</h5>

<p>dexFile中会包含修改过得patch,即加了$override的类,这里使用了多classLoader体系因为每个插件都创建了一个classLoader</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">load</span><span class="o">(){</span>
    <span class="k">try</span><span class="o">{</span>
    <span class="c1">//getPatchedClasses前面提到过,列出了改变的class</span>
      <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">className</span> <span class="o">:</span> <span class="n">getPatchedClasses</span><span class="o">())</span>
      <span class="o">{</span>
        <span class="c1">//初始化带override的类</span>
        <span class="n">ClassLoader</span> <span class="n">cl</span> <span class="o">=</span> <span class="n">getClass</span><span class="o">().</span><span class="na">getClassLoader</span><span class="o">();</span>
        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">aClass</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="n">className</span> <span class="o">+</span> <span class="s">"$override"</span><span class="o">);</span>
        <span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">aClass</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
        <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">originalClass</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="n">className</span><span class="o">);</span>
        <span class="n">Field</span> <span class="n">changeField</span> <span class="o">=</span> <span class="n">originalClass</span><span class="o">.</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"$change"</span><span class="o">);</span>
        
        <span class="n">changeField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        
        <span class="n">Object</span> <span class="n">previous</span> <span class="o">=</span> <span class="n">changeField</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">previous</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
        <span class="o">{</span>
          <span class="n">Field</span> <span class="n">isObsolete</span> <span class="o">=</span> <span class="n">previous</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">"$obsolete"</span><span class="o">);</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">isObsolete</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">isObsolete</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="kc">true</span><span class="o">));</span>
          <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">//反射调用,使得 $change = ..$override</span>
        <span class="n">changeField</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">o</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">Log</span><span class="o">.</span><span class="na">logging</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">logging</span><span class="o">.</span><span class="na">isLoggable</span><span class="o">(</span><span class="n">Level</span><span class="o">.</span><span class="na">FINE</span><span class="o">)))</span> <span class="o">{</span>
          <span class="n">Log</span><span class="o">.</span><span class="na">logging</span><span class="o">.</span><span class="na">log</span><span class="o">(</span><span class="n">Level</span><span class="o">.</span><span class="na">FINE</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"patched %s"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]</span> <span class="o">{</span> <span class="n">className</span> <span class="o">}));</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span>
    <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">Log</span><span class="o">.</span><span class="na">logging</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Log</span><span class="o">.</span><span class="na">logging</span><span class="o">.</span><span class="na">log</span><span class="o">(</span><span class="n">Level</span><span class="o">.</span><span class="na">SEVERE</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Exception while patching %s"</span><span class="o">,</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[]</span> <span class="o">{</span> <span class="s">"foo.bar"</span> <span class="o">}),</span> <span class="n">e</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
  <span class="o">}</span>
</code></pre>
</div>

<h4 id="编译">编译</h4>

<p><a href="http://blog.csdn.net/sgwhp/article/details/52423313">总结的很好</a></p>

<h5 id="首次编译">首次编译</h5>

<ul>
  <li>将<code class="highlighter-rouge">instant-run.jar</code>编译成<code class="highlighter-rouge">dex</code>，打入<code class="highlighter-rouge">apk</code>。</li>
  <li>修改<code class="highlighter-rouge">manifest</code>文件，将a<code class="highlighter-rouge">pplication</code>替换为<code class="highlighter-rouge">instant-run.jar</code>中的<code class="highlighter-rouge">BootstrapApplication</code>。</li>
  <li>app的所有类都添加类型为<code class="highlighter-rouge">IncrementalChange</code>的change字段，所有方法前面都添加一段代码，如果change字段不为空则调用change的<code class="highlighter-rouge">accessdispatch</code>方法并返回。编译出来的dex都将打包到<code class="highlighter-rouge">instant-run.zip</code>并打入apk。</li>
</ul>

<h5 id="非首次编译">非首次编译</h5>

<ul>
  <li><code class="highlighter-rouge">hot swap</code> 
根据修改的类生成一个新的实现<code class="highlighter-rouge">IncrementalChange</code>接口的新类，类名称为原名称加上<code class="highlighter-rouge">$override</code>，里面的方法大部分来自修改过后的类。以及生成对应的<code class="highlighter-rouge">AppPatchesLoaderImpl</code>，记录所有修改的类原名称。</li>
  <li><code class="highlighter-rouge">warm swap</code> 
生成新的<code class="highlighter-rouge">resources.arsc</code></li>
  <li><code class="highlighter-rouge">cold swap</code> 
重新生成修改类对应的dex</li>
</ul>

<h5 id="something">someThing</h5>

<p>由于首次编译时<code class="highlighter-rouge">application</code>已被替换成<code class="highlighter-rouge">BootstrapApplication</code>，启动的<code class="highlighter-rouge">application</code>自然也是它，重点:</p>

<blockquote>
  <p>调用setupClassLoaders将PathClassLoader的parent设置为IcreamentalClassLoader，而IcreamentalClassLoader的parent则设置为PathClassLoader的原parent即BootClassLoader，并且通过DelegateClassLoader代理完成findClass工作。相当于在PathClassLoader和BootClassLoader之间插入了一个DelegateClassLoader。此时instant-run.zip里面所有的dex以及后续修改代码生成的dex都已经在data/data的cache目录下，DelegateClassLoader会去这个目录进行class的加载。</p>
</blockquote>

<p><img src="/img/2017-05-02-multidex/14935282972784.jpg" alt="" /></p>

<h3 id="todo">todo</h3>

<ul>
  <li>dx :-multi-dex原理</li>
  <li>instant-run之资源补丁</li>
</ul>



                <hr>

                
                <!-- 多说 Share start -->
                </style>
                <div class="ds-share"
                    style="text-align: right"
                    data-thread-key="/2017/05/02/multiDex&InstantRun"
                    data-title="MultiDex & Instant Run"
                    data-url="http://localhost:5001/2017/05/02/multiDex&InstantRun/"
                    data-images="http://localhost:5001/img/2017-02-01-binder/pic.jpeg"
                    data-content="ClassLoader




  
    PathClassLoader是Android应用中的默认加载器，PathClassLoader只能加载/d... | Lizz0y's Notes " >
                    <div class="ds-share-inline">
                      <ul  class="ds-share-icons-16">
                        <li data-toggle="ds-share-icons-more"><a class="ds-more" href="#">分享到：</a></li>
                        <li><a class="ds-wechat flat" href="javascript:void(0);" data-service="wechat">微信</a></li>
                        <li><a class="ds-weibo flat" href="javascript:void(0);" data-service="weibo">微博</a></li>
                        <li><a class="ds-douban flat" href="javascript:void(0);" data-service="douban">豆瓣</a></li>
                      </ul>
                      <div class="ds-share-icons-more">
                      </div>
                    </div>
                <hr>
                </div>
                <!-- 多说 Share end-->
                


                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2017/05/02/andfix/" data-toggle="tooltip" data-placement="top" title="Andfix分析">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2017/05/05/droidPlugin2/" data-toggle="tooltip" data-placement="top" title="DroidPlugin系列之二">Next Post &rarr;</a>
                    </li>
                    
                </ul>


                
                <!-- 多说评论框 start -->
                <div class="comment">
                    <div class="ds-thread"
                        data-thread-key="/2017/05/02/multiDex&InstantRun"
                        data-title="MultiDex & Instant Run"
                        data-url="http://localhost:5001/2017/05/02/multiDex&InstantRun/" >
                    </div>
                </div>
                <!-- 多说评论框 end -->
                

                

            </div>

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
        				
                            
                				<a href="/tags/#Android" title="Android" rel="7">
                                    Android
                                </a>
                            
        				
                            
                				<a href="/tags/#SourceCode" title="SourceCode" rel="5">
                                    SourceCode
                                </a>
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#Linux" title="Linux" rel="3">
                                    Linux
                                </a>
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#DroidPlugin" title="DroidPlugin" rel="2">
                                    DroidPlugin
                                </a>
                            
        				
                            
        				
                            
                				<a href="/tags/#Java" title="Java" rel="6">
                                    Java
                                </a>
                            
        				
                            
        				
                            
                				<a href="/tags/#阅读笔记" title="阅读笔记" rel="2">
                                    阅读笔记
                                </a>
                            
        				
                            
                				<a href="/tags/#Concurrent" title="Concurrent" rel="5">
                                    Concurrent
                                </a>
                            
        				
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#插件化" title="插件化" rel="3">
                                    插件化
                                </a>
                            
        				
                            
                				<a href="/tags/#热补丁" title="热补丁" rel="2">
                                    热补丁
                                </a>
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#Weex" title="Weex" rel="2">
                                    Weex
                                </a>
                            
        				
                            
                				<a href="/tags/#Js" title="Js" rel="2">
                                    Js
                                </a>
                            
        				
                            
                				<a href="/tags/#源码分析" title="源码分析" rel="4">
                                    源码分析
                                </a>
                            
        				
                            
        				
                            
        				
                            
        				
        			</div>
                </section>
                

                <!-- Friends Blog -->
                
            </div>
        </div>
    </div>
</article>


<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
    // dynamic User by Hux
    var _user = 'lizz0y';

    // duoshuo comment query.
    var duoshuoQuery = {short_name: _user };
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0]
         || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
</script>
<!-- 多说公共JS代码 end -->







<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("http://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    

                    <!-- add Weibo, Zhihu by Hux, add target = "_blank" to <a> by Hux -->
                    
                    


                    
                    
                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Liz Notes 2017
                    <br>
                    Theme by <a href="http://huangxuan.me">Hux</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=huxpro&repo=huxpro.github.io&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js "></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("http://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->

<script>
    // dynamic User by Hux
    var _gaId = 'UA-49627206-1';
    var _gaDomain = 'huangxuan.me';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>



<!-- Baidu Tongji -->

<script>
    // dynamic User by Hux
    var _baId = '4cc1f2d8f3067386cc5cdb626a202900';

    // Originial
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?" + _baId;
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
</script>




<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
